# Express Middleware App

## Описание

Учебный проект на Node.js и Express.js с демонстрацией работы middleware, статических файлов, cookies, тем оформления и сессионной авторизации через Passport.  
В проекте реализованы шаблоны на PUG и EJS, а также защищённые маршруты.

---

## Техническое задание

### 1. Технологии
- **Node.js и Express.js** - основная платформа разработки

### 2. Passport для авторизации
- **Интеграция библиотеки Passport** для обработки авторизации пользователей
- **Конфигурация стратегии Passport** с использованием локальной авторизации (email + пароль)
- **Маршруты для регистрации, входа и выхода** пользователей с использованием функциональности Passport

### 3. Зберігання сесій
- **Налаштування Express сесій** для збереження стану авторизації користувача
- **Інтеграція сесій** з використанням express-session для тривалої авторизації
- **Збереження ідентифікатора сесії** у cookies з налаштуванням httpOnly та secure

### 4. Доступ до захищеного маршруту
- **Забезпечення доступу** до захищеного маршруту `/auth/protected` з використанням Passport
- **Впровадження мідлвару Passport**, який перевіряє наявність та валідність сесії користувача

---

## Функционал

- **Логгирование запросов:**
  - Кастомный middleware для логирования всех входящих запросов
  - Логи содержат метод, URL и время запроса
  - Логи выводятся в консоль сервера

- **Валидация данных:**
  - Использование celebrate и Joi для валидации данных
  - Валидация полей при регистрации и входе
  - Валидация данных пользователей и статей
  - Проверка корректности всех входящих запросов

- **CRUD-операции для пользователей:**
  - `POST /users` - создание нового пользователя
  - `PUT /users/:userId` - обновление данных пользователя
  - `DELETE /users/:userId` - удаление пользователя
  - `GET /users` - список всех пользователей
  - `GET /users/:userId` - информация о конкретном пользователе

- **CRUD-операции для статей:**
  - `POST /articles` - создание новой статьи (требует прав администратора)
  - `PUT /articles/:articleId` - обновление статьи (требует прав администратора)
  - `DELETE /articles/:articleId` - удаление статьи (требует прав администратора)
  - `GET /articles` - список всех статей (публичный доступ)
  - `GET /articles/:articleId` - просмотр статьи (публичный доступ)

- **Контроль доступа:**
  - Middleware checkArticleAccess для контроля доступа к статьям
  - Проверка роли пользователя через заголовок x-user-role
  - Публичный доступ к GET-запросам статей
  - Защита модифицирующих операций (POST, PUT, DELETE)

- **Корневой маршрут:**
  - `GET /` - возвращает приветственное сообщение

- **Статические файлы:**  
  - Сервер отдаёт favicon.ico и другие файлы из папки `src/public`.
  - Favicon отображается на всех страницах (PUG/EJS).

і **Работа с cookies:**  
  - Сохранение выбранной пользователем темы оформления (`/theme`).
  - Тема хранится в httpOnly cookie.
  - Глобальный middleware для применения темы ко всем шаблонам.

- **Сессионная авторизация через Passport:**  
  - Используется библиотека Passport и стратегия Local (email + пароль).
  - Сессии реализованы через express-session, id сессии хранится в httpOnly cookie.
  - Регистрация, вход и выход пользователя через Passport.
  - Защищённый маршрут `/auth/protected` доступен только авторизованным пользователям.

- **Шаблоны:**  
  - Используются PUG и EJS с поддержкой темы и favicon.
  - Адаптивный дизайн с поддержкой светлой и темной темы.

---

## Установка и запуск

```bash
npm install
npm run dev
```

Сервер стартует на порту 3000 (или на порту из переменной окружения `PORT`).

---

## Основные маршруты

- **Корневой маршрут:**
  - `GET /` - приветственное сообщение

- **Тема оформления:**  
  - `POST /theme`  
    Тело запроса: `{ "theme": "dark" }` или `{ "theme": "light" }`

- **Аутентификация и сессии:**  
  - `POST /auth/register` — регистрация пользователя  
    Тело: `{ "email": "test@example.com", "password": "12345" }`
  - `POST /auth/login` — вход пользователя  
    Тело: `{ "email": "test@example.com", "password": "12345" }`
  - `POST /auth/logout` — выход  
  - `GET /auth/protected` — защищённый маршрут (требует активной сессии)

- **Пользователи:**
  - `GET /users` - список пользователей
  - `GET /users/:userId` - детали пользователя
  - `POST /users` - создание пользователя
  - `PUT /users/:userId` - обновление пользователя
  - `DELETE /users/:userId` - удаление пользователя

- **Статьи:**
  - `GET /articles` - список статей (публичный доступ)
  - `GET /articles/:articleId` - просмотр статьи (публичный доступ)
  - `POST /articles` - создание статьи (требует прав администратора)
  - `PUT /articles/:articleId` - обновление статьи (требует прав администратора)
  - `DELETE /articles/:articleId` - удаление статьи (требует прав администратора)

---

## Тестирование функциональности

### Тестирование авторизации через Passport:

1. **Регистрация пользователя:**
   ```bash
   curl -X POST http://localhost:3000/auth/register \
     -H "Content-Type: application/json" \
     -d '{"email": "test@example.com", "password": "12345"}'
   ```

2. **Вход пользователя:**
   ```bash
   curl -X POST http://localhost:3000/auth/login \
     -H "Content-Type: application/json" \
     -d '{"email": "test@example.com", "password": "12345"}' \
     -c cookies.txt
   ```

3. **Доступ к защищенному маршруту:**
   ```bash
   curl -X GET http://localhost:3000/auth/protected \
     -b cookies.txt
   ```

4. **Выход пользователя:**
   ```bash
   curl -X POST http://localhost:3000/auth/logout \
     -b cookies.txt
   ```

### Тестирование сессий:
- Сессии сохраняются в httpOnly cookies
- Идентификатор сессии передается автоматически
- Сессия активна в течение 24 часов

### Тестирование темы оформления:
```bash
curl -X POST http://localhost:3000/theme \
  -H "Content-Type: application/json" \
  -d '{"theme": "dark"}' \
  -c cookies.txt
```

---

## Структура проекта

```
src/
  app.mjs                    # Основной файл приложения
  public/
    favicon.ico              # Иконка сайта
  views/
    pug/                     # Шаблоны PUG
      layout.pug
      users.pug
      userDetails.pug
    ejs/                     # Шаблоны EJS
      layout.ejs
      articles.ejs
      articleDetails.ejs
  routes/
    index.mjs                # Основные маршруты
    auth.mjs                 # Маршруты авторизации
    users.mjs                # Маршруты пользователей
    articles.mjs             # Маршруты статей
  middleware/
    theme.mjs                # Middleware для темы
    checkArticleAccess.mjs   # Middleware контроля доступа
    auth.mjs                 # Middleware авторизации
    passport.mjs             # Конфигурация Passport
  validators/
    userValidation.mjs       # Валидация пользователей
    articleValidation.mjs    # Валидация статей
```

---

## Требования

- Node.js 18+
- npm

---

## Автор

Студент курса Fullstack JS
